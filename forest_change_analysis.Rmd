---
title: "Mining-Induced Forest Change in Pra River Basin"
author: "Iris Nana Obeng"
date: "2025-11-18"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.path = "maps/")
```

## 1. Load Required Packages

#The following packages support raster processing, visualization, and change analysis:
- **terra** — for reading and manipulating Sentinel-2 rasters  
- **ggplot2** — plotting and visualization  
- **patchwork** — arranging plots side-by-side  
- **RStoolbox** — RGB rendering of multispectral imagery


```{r}
library(terra)
library(ggplot2)
library(patchwork)
library(RStoolbox)

## Enhanced ggplot-style imageRy function (im.ggplotRGB)
im.ggplotRGB <- function(rgb_stack, r = 1, g = 2, b = 3, 
                        stretch = "lin", title = "", downsample = 10) {
  
  # Downsample the raster first to reduce memory
  rgb_small <- aggregate(rgb_stack, fact = downsample)
  
  # Convert only the downsampled version to data frame
  rgb_df <- as.data.frame(rgb_small, xy = TRUE)
  rgb_df <- na.omit(rgb_df)
  
  band_names <- names(rgb_df)[3:5]
  
  # Create ggplot
  p <- ggplot() +
    geom_raster(data = rgb_df, 
                aes(x = x, y = y, 
                    fill = rgb(
                      get(band_names[r]), 
                      get(band_names[g]), 
                      get(band_names[b]),
                      maxColorValue = max(c(get(band_names[r]), 
                                          get(band_names[g]), 
                                          get(band_names[b])), na.rm = TRUE)
                    ))) +
    scale_fill_identity() +
    coord_equal() +
    labs(title = title) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
          axis.text = element_text(size = 8),
          panel.grid = element_blank())
  
  return(p)
}
```

## 2. Loading Sentinel-2 Bands

### 2017 Bands
```{r}
blue_2017  <- rast("./S2A_MSIL2A_20170127T102301_N0500_R065_T30NXM_20230921T203317.SAFE/T30NXM_20170127T102301_B02_10m.jp2")
green_2017 <- rast("./S2A_MSIL2A_20170127T102301_N0500_R065_T30NXM_20230921T203317.SAFE/T30NXM_20170127T102301_B03_10m.jp2")
red_2017   <- rast("./S2A_MSIL2A_20170127T102301_N0500_R065_T30NXM_20230921T203317.SAFE/T30NXM_20170127T102301_B04_10m.jp2")
nir_2017   <- rast("./S2A_MSIL2A_20170127T102301_N0500_R065_T30NXM_20230921T203317.SAFE/T30NXM_20170127T102301_B08_10m.jp2")
```

### 2020 Bands
```{r}
blue_2020  <- rast("./S2A_MSIL2A_20200112T102401_N0500_R065_T30NXM_20230424T091251.SAFE/T30NXM_20200112T102401_B02_10m.jp2")
green_2020 <- rast("./S2A_MSIL2A_20200112T102401_N0500_R065_T30NXM_20230424T091251.SAFE/T30NXM_20200112T102401_B03_10m.jp2")
red_2020   <- rast("./S2A_MSIL2A_20200112T102401_N0500_R065_T30NXM_20230424T091251.SAFE/T30NXM_20200112T102401_B04_10m.jp2")
nir_2020   <- rast("./S2A_MSIL2A_20200112T102401_N0500_R065_T30NXM_20230424T091251.SAFE/T30NXM_20200112T102401_B08_10m.jp2")
```

### 2022 Bands
```{r}
blue_2022  <- rast("./S2B_MSIL2A_20220126T102209_N0510_R065_T30NXM_20240506T042828.SAFE/T30NXM_20220126T102209_B02_10m.jp2")
green_2022 <- rast("./S2B_MSIL2A_20220126T102209_N0510_R065_T30NXM_20240506T042828.SAFE/T30NXM_20220126T102209_B03_10m.jp2")
red_2022   <- rast("./S2B_MSIL2A_20220126T102209_N0510_R065_T30NXM_20240506T042828.SAFE/T30NXM_20220126T102209_B04_10m.jp2")
nir_2022   <- rast("./S2B_MSIL2A_20220126T102209_N0510_R065_T30NXM_20240506T042828.SAFE/T30NXM_20220126T102209_B08_10m.jp2")
```

## 3. Image Composites

#RGB = True color
#NIR–R–G = False color (highlights vegetation health)

```{r}
# RGB Stacks (True Color)
rgb_2017 <- c(red_2017, green_2017, blue_2017)
rgb_2020 <- c(red_2020, green_2020, blue_2020)
rgb_2022 <- c(red_2022, green_2022, blue_2022)

# False Color Stacks (NIR-Red-Green)
false_2017 <- c(nir_2017, red_2017, green_2017)
false_2020 <- c(nir_2020, red_2020, green_2020)
false_2022 <- c(nir_2022, red_2022, green_2022)
```


## 4. True Color Visualization 

```{r true_color_panel, fig.width=18, fig.height=6, out.width='100%'}
# Create plots using im.ggplotRGB function
tc_2017 <- im.ggplotRGB(rgb_2017, title = "2017 - True Color")
tc_2020 <- im.ggplotRGB(rgb_2020, title = "2020 - True Color") 
tc_2022 <- im.ggplotRGB(rgb_2022, title = "2022 - True Color")

# Combine using patchwork
true_color_panel <- (tc_2017 | tc_2020 | tc_2022) +
  plot_annotation(
    title = "True Color RGB – Pra River Basin (2017, 2020, 2022)",
    theme = theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))
  )

true_color_panel

ggsave("maps/true_color_panel.png", true_color_panel, width = 15, height = 6, dpi = 300)
```

## 5. False Color Visualization

#False color imagery uses NIR to display vegetation health.
Healthy vegetation appears bright red; stressed vegetation appears dull.

```{r false_color_panel, fig.width=18, fig.height=6, out.width='100%'}
# Create plots using im.ggplotRGB function for false color
fc_2017 <- im.ggplotRGB(false_2017, r = 1, g = 2, b = 3, title = "2017 - False Color")
fc_2020 <- im.ggplotRGB(false_2020, r = 1, g = 2, b = 3, title = "2020 - False Color")
fc_2022 <- im.ggplotRGB(false_2022, r = 1, g = 2, b = 3, title = "2022 - False Color")

# Combine using patchwork
false_color_panel <- (fc_2017 | fc_2020 | fc_2022) +
  plot_annotation(
    title = "False Color (NIR-R-G): Vegetation Health",
    theme = theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))
  )

false_color_panel

ggsave("maps/false_color_panel.png", false_color_panel, width = 15, height = 6, dpi = 300)
```

## 6. NDVI Calculation and Analysis

#NDVI = (NIR – Red) / (NIR + Red)
This index quantifies vegetation greenness and essential for detecting forest loss or stress.

```{r}
# Calculate NDVI
ndvi_2017 <- (nir_2017 - red_2017) / (nir_2017 + red_2017)
ndvi_2020 <- (nir_2020 - red_2020) / (nir_2020 + red_2020)
ndvi_2022 <- (nir_2022 - red_2022) / (nir_2022 + red_2022)

# Downsample for memory management
ndvi_2017s <- aggregate(ndvi_2017, fact=10)
ndvi_2020s <- aggregate(ndvi_2020, fact=10)
ndvi_2022s <- aggregate(ndvi_2022, fact=10)
```

## 7. Change Detection Analysis

#-New exposed soil (mining expansion)
#-Degraded / disturbed vegetation
#-No change

#Thresholds: -Bare soil: NDVI < 0.25            -Healthy forest: NDVI > 0.45


```{r}
# Identify vegetation changes
bare17 <- ndvi_2017 < 0.25
bare22 <- ndvi_2022 < 0.25
new_bare <- bare22 & (!bare17)

# Degraded / disturbed vegetation (drop from healthy to stressed)
degraded <- (ndvi_2022 < ndvi_2017) & 
            (ndvi_2022 >= 0.25) & 
            (ndvi_2017 >= 0.45)

# Create change classification
change <- ndvi_2022 * 0
change[] <- 0
change[new_bare] <- 1
change[degraded] <- 2

# Downsample for visualization
change_small <- aggregate(change, fact = 10, fun = modal, na.rm = TRUE)
```

```{r}
mining_hotspots <- new_bare
disturbed_vegetation <- degraded

healthy_forest <- (ndvi_2022 > 0.45)
other_landcover <- !(mining_hotspots | disturbed_vegetation | healthy_forest)

# Create three separate rasters
mining_raster <- ndvi_2022 * 0
mining_raster[mining_hotspots] <- 1

disturbed_raster <- ndvi_2022 * 0  
disturbed_raster[disturbed_vegetation] <- 1

forest_health_raster <- ndvi_2022 * 0
forest_health_raster[healthy_forest] <- 1
forest_health_raster[other_landcover] <- 2
# Downsample for visualization
mining_small <- aggregate(mining_raster, fact = 10, fun = modal, na.rm = TRUE)
disturbed_small <- aggregate(disturbed_raster, fact = 10, fun = modal, na.rm = TRUE)
forest_health_small <- aggregate(forest_health_raster, fact = 10, fun = modal, na.rm = TRUE)
```

## 8. Change Classification Maps

# 1. Forest health map - show healthy forest areas
# 2. Mining hotspots map - show exposed soil from mining  
# 3. Disturbed vegetation map - show degraded forest areas due to mining impacts

```{r change_maps, fig.width=18, fig.height=6, out.width='100%'}
# Mining Hotspots Map
mining_df <- as.data.frame(mining_small, xy = TRUE)
mining_df <- na.omit(mining_df)
colnames(mining_df) <- c("x", "y", "value")

mining_map <- ggplot() +
  geom_raster(data = mining_df, 
              aes(x = x, y = y, fill = factor(value))) +
  scale_fill_manual(
    values = c("0" = "honeydew", "1" = "brown4"),
    labels = c("Non-Active Mining Areas", "Active Mining Areas"),
    name = "Land Cover Change"
  ) +
  coord_equal() +
  labs(
    title = "Mining Expansion: Exposed Soil Areas (2017 → 2022)",
    subtitle = "New areas of vegetation removal due to mining activities"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 10),
        axis.text = element_text(size = 10),
        panel.grid = element_blank())

# Disturbed Vegetation Map  
disturbed_df <- as.data.frame(disturbed_small, xy = TRUE)
disturbed_df <- na.omit(disturbed_df)
colnames(disturbed_df) <- c("x", "y", "value")

disturbed_map <- ggplot() +
  geom_raster(data = disturbed_df, 
              aes(x = x, y = y, fill = factor(value))) +
  scale_fill_manual(
    values = c("0" = "forestgreen", "1" = "yellow"),
    labels = c("Healthy Vegetation", "Disturbed Vegetation"),
    name = "Vegetation Status"
  ) +
  coord_equal() +
  labs(title = "Disturbed Vegetation (2017-2022)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        axis.text = element_text(size = 8),
        panel.grid = element_blank())

# Forest Health Map
forest_health_df <- as.data.frame(forest_health_small, xy = TRUE)
forest_health_df <- na.omit(forest_health_df)
colnames(forest_health_df) <- c("x", "y", "value")
forest_health_map <- ggplot() +
  geom_raster(data = forest_health_df, 
               aes(x = x, y = y, fill = factor(value))) +
  scale_fill_manual(values = c("0" = "beige", "1" = "darkgreen", "2" = "tan"),
                    labels = c("Other Land Uses", "Healthy Forest", "Vulnerable Areas"),
    name = "Forest Conservation Status"
  ) +
  coord_equal() +
  labs(
    title = "Forest Conservation Status in Pra River Basin (2022)",
    subtitle = "Identifying healthy forests and areas vulnerable to mining expansion") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        axis.text = element_text(size = 10),
        panel.grid = element_blank())

# Display each map individually
forest_health_map
mining_map
disturbed_map

# Save maps
ggsave("maps/mining_hotspots_map.png", mining_map, width = 6, height = 6, dpi = 300)
ggsave("maps/disturbed_vegetation_map.png", disturbed_map, width = 6, height = 6, dpi = 300)
ggsave("maps/forest_health_map.png", forest_health_map, width = 6, height = 6, dpi = 300)
```

## 9. Summary
This analysis utilized Sentinel-2 imagery to assess mining-induced forest changes in the Pra River Basin from 2017 to 2022. True color and false color composites highlighted visible changes and vegetation health. NDVI calculations identified areas of new exposed soil due to mining expansion and degraded vegetation. The resulting maps provide critical insights into the spatial extent of mining impacts on forest ecosystems, informing conservation and land management strategies.
```







